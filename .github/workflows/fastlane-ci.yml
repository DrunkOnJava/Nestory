name: Fastlane iOS Automation

on:
  push:
    branches: [ main, develop, release/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      lane:
        description: 'Fastlane lane to run'
        required: true
        default: 'tests'
        type: choice
        options:
        - tests
        - coverage_validation  
        - beta
        - screenshots
        - enterprise_test_suite

env:
  # Fastlane environment variables for CI
  FASTLANE_SKIP_UPDATE_CHECK: 1
  FASTLANE_HIDE_CHANGELOG: 1
  LC_ALL: C
  LANG: C
  DEVELOPER_DIR: /Applications/Xcode_15.0.app/Contents/Developer

concurrency:
  group: fastlane-${{ github.ref }}-${{ github.event.inputs.lane || 'tests' }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  fastlane-automation:
    name: Fastlane iOS Automation
    runs-on: macos-14
    timeout-minutes: 30
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version-file: .ruby-version
          bundler-cache: true
          cache-version: 1
          
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.0'
          
      # Multi-tier caching for optimal performance
      - name: Cache Bundler Dependencies
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-
            
      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/Developer/Xcode/DerivedData/ModuleCache.noindex
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved', '**/project.yml') }}
          restore-keys: |
            ${{ runner.os }}-spm-
            
      - name: Cache Fastlane Build Artifacts
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData/Nestory-*
            fastlane/output
          key: ${{ runner.os }}-fastlane-${{ hashFiles('**/*.swift', '**/Fastfile', '**/project.yml') }}
          restore-keys: |
            ${{ runner.os }}-fastlane-
            
      - name: Bootstrap Fastlane Environment
        run: |
          echo "🚀 Bootstrapping Fastlane environment..."
          make bootstrap
          
      - name: Validate Fastlane Configuration
        run: |
          echo "🔍 Validating Fastlane setup..."
          ./bin/fastlane --version
          ./bin/fastlane lanes
          
      - name: Run Fastlane Lane
        run: |
          LANE="${{ github.event.inputs.lane || 'tests' }}"
          echo "🎯 Running Fastlane lane: $LANE"
          
          case "$LANE" in
            "tests")
              ./bin/fastlane ios tests
              ;;
            "coverage_validation")
              ./bin/fastlane ios coverage_validation
              ;;
            "beta")
              ./bin/fastlane ios beta skip_tests:true
              ;;
            "screenshots")
              ./bin/fastlane ios screenshots
              ;;
            "enterprise_test_suite")
              ./bin/fastlane ios enterprise_test_suite
              ;;
            *)
              echo "❌ Unknown lane: $LANE"
              exit 1
              ;;
          esac
          
      - name: Upload Fastlane Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fastlane-logs-${{ github.run_number }}
          path: |
            fastlane/output/
            fastlane/logs/
            *.log
          retention-days: 7
          
      - name: Upload Test Results
        if: always() && (github.event.inputs.lane == 'tests' || github.event.inputs.lane == 'coverage_validation' || github.event.inputs.lane == 'enterprise_test_suite' || github.event.inputs.lane == '')
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_number }}
          path: |
            fastlane/output/tests/
            fastlane/output/coverage/
            *.xcresult
          retention-days: 7
          
      - name: Upload Screenshots
        if: always() && (github.event.inputs.lane == 'screenshots' || contains(github.event.inputs.lane, 'test_suite'))
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ github.run_number }}
          path: |
            fastlane/output/screenshots/
            ~/Desktop/NestoryUIWiringScreenshots/
          retention-days: 7
          
      - name: Generate Summary
        if: always()
        run: |
          LANE="${{ github.event.inputs.lane || 'tests' }}"
          
          echo "# 📱 Fastlane Automation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Lane:** $LANE" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "✅ **Result:** Fastlane automation completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Result:** Fastlane automation failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 📊 Artifacts Generated" >> $GITHUB_STEP_SUMMARY
          echo "- Fastlane logs and output" >> $GITHUB_STEP_SUMMARY
          
          if [[ "$LANE" == "tests" || "$LANE" == "coverage_validation" || "$LANE" == "enterprise_test_suite" ]]; then
            echo "- Test results and coverage reports" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "$LANE" == "screenshots" ]]; then
            echo "- Generated screenshots for App Store" >> $GITHUB_STEP_SUMMARY
          fi